# OAuth認証設定ガイド

本システムをLabNexus認証サーバーと連携させるための設定手順です。

## 前提条件

- LabNexus認証サーバーが稼働していること（デフォルト: http://localhost:3030）
- LabNexusでOAuthクライアントとサービスアカウントが作成されていること

## 設定手順

### 1. 認証サーバーでの準備

#### 1.1 サービスアカウントの作成

LabNexus管理画面でサービスアカウントを作成し、APIキーを取得してください。

#### 1.2 OAuthクライアントの作成

LabNexus管理画面でOAuthクライアントを作成し、以下の情報を取得してください：

- **Client ID**: OAuthクライアントの識別子
- **Client Secret**: OAuthクライアントのシークレット
- **Redirect URI**: `http://localhost:5000/auth/callback`（本番環境では適切なドメインに変更）

### 2. 本システムの設定

#### 2.1 環境変数ファイルの作成

`.env.example`をコピーして`.env`ファイルを作成します：

```bash
cp .env.example .env
```

#### 2.2 環境変数の設定

`.env`ファイルを編集し、以下の値を設定してください：

```env
# 認証サーバーの設定
# ⚠️ Docker使用時は host.docker.internal を使用してください
AUTH_SERVER_BASE_URL=http://host.docker.internal:3030

# OAuthクライアント設定（認証サーバーから取得した値を設定）
OAUTH_CLIENT_ID=your_client_id_here
OAUTH_CLIENT_SECRET=your_client_secret_here
OAUTH_REDIRECT_URI=http://localhost:5000/auth/callback

# APIキー（サーバー間通信用、サービスアカウントから取得）
API_KEY=your_api_key_here

# スコープ（必要な権限を設定）
OAUTH_SCOPE=read:profile

# セッション用のシークレットキー（本番環境では必ず変更）
SECRET_KEY=your-secret-key-change-in-production
```

**重要**: 
- **Docker使用時**: `AUTH_SERVER_BASE_URL=http://host.docker.internal:3030`
- **ローカル実行時（Dockerなし）**: `AUTH_SERVER_BASE_URL=http://localhost:3030`

### 3. アプリケーションの起動

#### Dockerでの起動（推奨）

```bash
docker compose up -d --build
```

#### ローカル起動（開発用）

```bash
# 依存パッケージのインストール
pip install -r requirements.txt

# アプリケーションの起動
cd opt
python main.py
```

### 4. 動作確認

1. ブラウザで `http://localhost:5000/login` にアクセス
2. 認証サーバーのログインページにリダイレクトされることを確認
3. メールアドレスとパスワードでログイン
4. 図書管理システムのトップページにリダイレクトされることを確認
5. ユーザー名が表示されていることを確認

## トラブルシューティング

### 認証サーバーに接続できない（Connection refused エラー）

**エラーメッセージ例**:
```
Failed to establish a new connection: [Errno 111] Connection refused
```

**原因と解決方法**:
- **Docker使用時**: コンテナ内から`localhost`でホストマシンにアクセスできません
  - **解決**: `.env`ファイルで`AUTH_SERVER_BASE_URL=http://host.docker.internal:3030`に変更
- **ローカル実行時**: 認証サーバーが起動しているか確認
  - 認証サーバーが`http://localhost:3030`で起動しているか確認
  - ファイアウォール設定を確認

### ログインできない

- `.env`ファイルの設定値が正しいか確認
- 認証サーバーが起動しているか確認
- `OAUTH_REDIRECT_URI`が認証サーバーで登録されているか確認

### トークンエラーが発生する

- `API_KEY`が正しいか確認
- サービスアカウントが有効か確認
- OAuthクライアントがサービスアカウントに紐づいているか確認

### セッションが維持されない

- `SECRET_KEY`が設定されているか確認
- ブラウザのCookieが有効になっているか確認

## セキュリティに関する注意事項

- **本番環境では必ず`SECRET_KEY`を変更してください**
- `.env`ファイルは`.gitignore`に含まれており、Gitにコミットされません
- `OAUTH_CLIENT_SECRET`と`API_KEY`は絶対に公開しないでください
- HTTPSを使用することを強く推奨します（本番環境）

## 参考リンク

- OAuth 2.0フロー詳細: [documents/簡易OAuth.md](./簡易OAuth.md)
- LabNexus認証サーバードキュメント: （認証サーバーのドキュメントを参照）
