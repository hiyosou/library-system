# OAuth認証機能実装完了

## 実装概要

`簡易OAuth.md`に記載されているOAuth 2.0 Authorization Code Flowに基づいて、本図書管理システムをアプリサーバーとして認証サーバー（LabNexus）と通信できるように実装しました。

## 実装内容

### 1. 新規作成ファイル

#### `opt/config.py`
- OAuth設定を管理
- 環境変数から認証サーバーのURL、クライアント情報、APIキーなどを読み込み

#### `opt/service/oauth.py`
- OAuth認証サービスクラス
- 主要メソッド：
  - `get_authorization_url()`: 認証URLの生成
  - `exchange_code_for_token()`: 認証コードをトークンに交換
  - `get_user_info()`: アクセストークンでユーザー情報取得
  - `refresh_token()`: リフレッシュトークンで新しいアクセストークン取得
  - `validate_token()`: トークンの有効性検証（サーバー間通信）
  - `revoke_token()`: トークンの無効化（サーバー間通信）

#### `opt/router/auth.py`
- OAuth認証ルーター
- エンドポイント：
  - `GET /auth/login`: OAuth認証フローの開始
  - `GET /auth/callback`: 認証サーバーからのコールバック処理
  - `GET /auth/logout`: ログアウト処理
  - `GET /auth/user`: 現在のユーザー情報取得
  - `GET /auth/validate`: トークン検証

#### `opt/templates/error.html`
- 認証エラー表示ページ

#### `documents/設定ガイド.md`
- OAuth認証の設定手順書

#### `.env.example`
- 環境変数のサンプルファイル

### 2. 更新ファイル

#### `opt/main.py`
- 環境変数読み込み機能を追加（python-dotenv）
- セッション設定を追加
- OAuth認証ルーターを登録
- `/login`エンドポイントをOAuth認証フローにリダイレクト

#### `opt/templates/index.html`
- ユーザー情報表示機能を追加
- ログアウトボタンを追加
- ページ読み込み時にユーザー情報を取得

#### `opt/templates/login.html`
- OAuth認証フローへのリンクを更新
- デザインを改善

#### `requirements.txt`
- `requests`: HTTP通信用
- `python-dotenv`: 環境変数読み込み用

#### `docker-compose.yml`
- 環境変数の設定を追加
- `.env`ファイルの読み込みを設定

#### `.gitignore`
- `.env`ファイルを追加（機密情報の保護）

#### `README.md`
- OAuth認証の概要と設定手順を追加

## OAuth 2.0フロー実装

### フロー1: Authorization Code Flow（ユーザーログイン）

1. ユーザーが`/login`にアクセス
2. stateパラメータを生成してセッションに保存
3. 認証サーバーの`/oauth/client/authorize`にリダイレクト
4. ユーザーが認証サーバーでログイン
5. 認証コードとstateが`/auth/callback`に返される
6. stateを検証してCSRF対策
7. 認証コードをアクセストークンに交換（`/oauth/client/token`）
8. アクセストークンでユーザー情報を取得（`/oauth/client/userinfo`）
9. セッションに保存してログイン完了

### フロー2: トークンリフレッシュ

- トークンの有効期限が切れた場合、自動的にリフレッシュトークンで新しいアクセストークンを取得

### フロー3: サーバー間通信

- APIキーを使用してトークンの検証や無効化を実行
- `X-API-Key`ヘッダーで認証

## セキュリティ機能

1. **CSRF対策**: stateパラメータによる検証
2. **セッション管理**: Flask Session による安全なセッション管理
3. **環境変数**: 機密情報を環境変数で管理
4. **トークン無効化**: ログアウト時にトークンを無効化

## 設定方法

1. `.env.example`をコピーして`.env`を作成
2. 認証サーバーから取得した以下の情報を設定：
   - `OAUTH_CLIENT_ID`
   - `OAUTH_CLIENT_SECRET`
   - `API_KEY`
3. 必要に応じて他の設定を変更
4. `docker compose up -d --build`で起動

詳細は`documents/設定ガイド.md`を参照してください。

## 動作確認

1. `http://localhost:5000/login`にアクセス
2. 認証サーバーのログインページでログイン
3. 図書管理システムにリダイレクトされる
4. ユーザー名が表示される
5. ログアウトボタンでログアウト可能

## 参考ドキュメント

- `documents/簡易OAuth.md`: OAuth 2.0フローの詳細
- `documents/設定ガイド.md`: 設定手順
- `README.md`: プロジェクト概要
