<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“š é«˜æ©‹ç ”ç©¶å®¤ æ›¸ç±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
</head>
<body>
    <h1>ğŸ“šé«˜æ©‹ç ”ç©¶å®¤æ›¸ç±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>

    <!-- -------------------------
         âœ… æ–°è¦ç™»éŒ²
    -------------------------- -->
    <h2>æ–°ã—ã„æœ¬ã‚’ç™»éŒ²</h2>
    <form id="addBookForm">
        <input type="text" id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" required>
        <input type="text" id="author" placeholder="è‘—è€…" required>
        <button type="submit">ç™»éŒ²</button>
    </form>
    <div id="pushresult" style="margin-top:20px; color:green;"></div>


    <!-- -------------------------
         âœ… æœ¬ã®æ¤œç´¢
    -------------------------- -->
    <h2>æœ¬ã‚’æ¤œç´¢</h2>
    <input type="text" id="searchBox" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è‘—è€…ã§æ¤œç´¢...">
    <ul id="bookList"></ul>


    <!-- -------------------------
         âœ… æ›¸ç±ä¸€è¦§è¡¨ç¤º
    -------------------------- -->
    <h2>æ›¸ç±ä¸€è¦§</h2>
    <button id="loadBooksBtn">æ›¸ç±ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€</button>
    <ul id="booksList"></ul>
    <div id="loadresult" style="margin-top:10px; color:blue;"></div>


    <!-- -------------------------
         âœ… æ›´æ–°
    -------------------------- -->
    <h2>æœ¬ã®æƒ…å ±ã‚’æ›´æ–°</h2>
    <form id="updateBookForm">
        <input type="number" id="updateId" placeholder="æ›¸ç±ID" required>
        <input type="text" id="newTitle" placeholder="æ–°ã—ã„ã‚¿ã‚¤ãƒˆãƒ«">
        <input type="text" id="newAuthor" placeholder="æ–°ã—ã„è‘—è€…">
        <button type="submit">æ›´æ–°</button>
    </form>
    <div id="putresult" style="margin-top:20px; color:green;"></div>


    <!-- -------------------------
         âœ… å‰Šé™¤
    -------------------------- -->
    <h2>æœ¬ã‚’å‰Šé™¤</h2>
    <form id="deleteBookForm">
        <input type="number" id="deleteId" placeholder="æ›¸ç±ID" required>
        <button type="submit">å‰Šé™¤</button>
    </form>
    <div id="deleteresult" style="margin-top:20px; color:red;"></div>


    <script>
        // âœ… ä¸€å…ƒç®¡ç†ã™ã‚‹æœ¬ãƒ‡ãƒ¼ã‚¿
        let allBooks = [];

        // âœ… API ã‹ã‚‰æ›¸ç±ä¸€è¦§ã‚’å–å¾—ã— allBooks ã«ä¿å­˜
        async function fetchBooks() {
            try {
                const response = await fetch("/books");
                allBooks = await response.json();
                return allBooks;
            } catch (error) {
                console.error("API ã‚¨ãƒ©ãƒ¼:", error);
                return [];
            }
        }

        // âœ… æ¤œç´¢è¡¨ç¤ºç”¨ï¼ˆsearchBoxç”¨ï¼‰
        function displaySearchBooks(list) {
            const bookList = document.getElementById("bookList");
            bookList.innerHTML = "";
            list.forEach(book => {
                const li = document.createElement("li");
                li.textContent = `${book.title} (${book.author})`;
                bookList.appendChild(li);
            });
        }

        // âœ… ä¸€è¦§è¡¨ç¤ºç”¨
        function displayFullList(list) {
            const target = document.getElementById("booksList");
            target.innerHTML = "";
            list.forEach(book => {
                const li = document.createElement("li");
                li.textContent = `ID: ${book.id} / ã‚¿ã‚¤ãƒˆãƒ«: ${book.title} / è‘—è€…: ${book.author}`;
                target.appendChild(li);
            });
            document.getElementById("loadresult").innerText = `${list.length}ä»¶ã®æ›¸ç±ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`;
        }

        // âœ… ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ã§ä¸€è¦§å–å¾—
        window.addEventListener("DOMContentLoaded", async () => {
            const books = await fetchBooks();
            displayFullList(books);
            displaySearchBooks(books);
        });

        // âœ… æ‰‹å‹•èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
        document.getElementById("loadBooksBtn").addEventListener("click", async () => {
            document.getElementById("loadresult").innerText = "èª­ã¿è¾¼ã¿ä¸­...";
            const books = await fetchBooks();
            displayFullList(books);
        });

        // âœ… æ¤œç´¢å‡¦ç†
        document.getElementById("searchBox").addEventListener("input", (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = allBooks.filter(book =>
                book.title.toLowerCase().includes(keyword) ||
                book.author.toLowerCase().includes(keyword)
            );
            displaySearchBooks(filtered);
        });

        // âœ… æ–°è¦ç™»éŒ²
        document.getElementById("addBookForm").addEventListener("submit", async event => {
            event.preventDefault();
            const title = document.getElementById("title").value;
            const author = document.getElementById("author").value;

            const response = await fetch("/books", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ title, author })
            });

            const data = await response.json();
            document.getElementById("pushresult").innerText = data.message;

            // å†èª­ã¿è¾¼ã¿
            const books = await fetchBooks();
            displayFullList(books);
            displaySearchBooks(books);

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            document.getElementById("title").value = "";
            document.getElementById("author").value = "";
        });

        // âœ… æ›´æ–°
        document.getElementById("updateBookForm").addEventListener("submit", async event => {
            event.preventDefault();
            const id = document.getElementById("updateId").value;
            const newTitle = document.getElementById("newTitle").value;
            const newAuthor = document.getElementById("newAuthor").value;

            const response = await fetch(`/books/${id}`, {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ title: newTitle, author: newAuthor })
            });

            const data = await response.json();
            document.getElementById("putresult").innerText = data.message;

            const books = await fetchBooks();
            displayFullList(books);
            displaySearchBooks(books);

            document.getElementById("updateId").value = "";
            document.getElementById("newTitle").value = "";
            document.getElementById("newAuthor").value = "";
        });

        // âœ… å‰Šé™¤
        document.getElementById("deleteBookForm").addEventListener("submit", async event => {
            event.preventDefault();
            const id = document.getElementById("deleteId").value;

            const response = await fetch(`/books/${id}`, { method: "DELETE" });
            const data = await response.json();
            document.getElementById("deleteresult").innerText = data.message;

            const books = await fetchBooks();
            displayFullList(books);
            displaySearchBooks(books);

            document.getElementById("deleteId").value = "";
        });
    </script>
</body>
</html>
